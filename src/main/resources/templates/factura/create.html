<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Nueva Factura</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<!-- Header reutilizable -->
<div th:replace="~{fragments/header :: menu}"></div>
<div class="container py-4">
  <h3>Nueva Factura</h3>

  <div class="card shadow-sm">
    <div class="card-body">
      <form th:action="@{/factura/save}" th:object="${factura}" method="post">
        <div class="row g-3">

          <!-- ✅ OBRA -->
          <div class="col-md-6">
            <label class="form-label">Obra *</label>
            <select class="form-select" id="obraSeleccionada">
              <option value="">-- Seleccione --</option>
              <option th:each="ob : ${obras}"
                      th:value="${ob.idObra}"
                      th:text="${ob.empresa.nombre + ' - ' + ob.nombre}">
              </option>
            </select>
            <small class="text-muted">Primero elige obra para filtrar órdenes.</small>
          </div>

          <!-- ✅ ORDEN (autocomplete) -->
          <!-- ✅ ORDEN (autocomplete tipo navegador) -->
			<div class="col-md-6 position-relative">
			  <label class="form-label">Orden *</label>
			
			  <input class="form-control"
			         id="ordenBusqueda"
			         placeholder="Escribe: OS123 / OC456"
			         autocomplete="off"
			         disabled>
			
			  <!-- Lista de sugerencias (se llena con JS) -->
			  <div id="ordenSugerencias"
			       class="list-group position-absolute w-100"
			       style="z-index: 2000; display:none; max-height: 220px; overflow:auto;">
			  </div>
			
			  <!-- ✅ Este es el valor real que se envía al controller -->
			  <input type="hidden" th:field="*{orden.idOrden}" id="ordenId">
			
			  <div class="text-danger" th:if="${#fields.hasErrors('orden')}" th:errors="*{orden}"></div>
			  <small class="text-muted" id="ordenInfo"></small>
			  <div class="text-danger" id="ordenError" style="display:none;"></div>
			</div>

          <!-- ✅ VALORIZACIÓN (solo de la orden elegida) -->
          <div class="col-md-6">
            <label class="form-label">Valorización (si aplica)</label>
            <select class="form-select" th:field="*{valorizacion.idValorizacion}" id="valorizacionSelect" disabled>
              <option value="">-- (sin valorización) --</option>
            </select>
            <div class="text-danger" th:if="${#fields.hasErrors('valorizacion')}" th:errors="*{valorizacion}"></div>
            <small class="text-muted" id="valInfo"></small>
          </div>

          <!-- Serie -->
          <div class="col-md-3">
            <label class="form-label">Serie (opcional)</label>
            <input class="form-control" th:field="*{serieFactura}" list="listaSeries" placeholder="Ej: F001">
            <datalist id="listaSeries">
              <option th:each="s : ${seriesFactura}" th:value="${s}"></option>
            </datalist>
          </div>

          <!-- Número -->
          <div class="col-md-3">
            <label class="form-label">Número *</label>
            <input class="form-control" th:field="*{numeroFactura}" placeholder="Ej: 000123">
            <div class="text-danger" th:errors="*{numeroFactura}"></div>
          </div>

          <!-- Fecha emisión -->
          <div class="col-md-3">
            <label class="form-label">Fecha de emisión</label>
            <input type="date" class="form-control" th:field="*{fechaEmision}" readonly>
          </div>

          <!-- Días pago -->
          <div class="col-md-3">
            <label class="form-label">Días de pago *</label>
            <input class="form-control" type="number" min="1" th:field="*{diasPago}">
          </div>

          <div class="col-md-4">
            <label class="form-label">¿Aplica detracción?</label>
            <select class="form-select" th:field="*{aplicaDetraccion}">
              <option th:value="true">SÍ</option>
              <option th:value="false">NO</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">¿Aplica fondo de garantía?</label>
            <select class="form-select" th:field="*{aplicaFondoGarantia}">
              <option th:value="false">NO</option>
              <option th:value="true">SÍ</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">% Fondo garantía</label>
            <input class="form-control" type="number" step="0.01" min="0" max="20"
                   th:field="*{porcentajeFondoGarantia}" placeholder="Ej: 5.00">
          </div>

          <div class="col-12">
            <div class="alert alert-warning mb-0">
              Total/Detracción/Fondo/Neto se calculan automáticamente al guardar.
            </div>
          </div>

        </div>

        <div class="mt-4 d-flex gap-2">
          <button class="btn btn-success" type="submit">Guardar</button>
          <a class="btn btn-secondary" th:href="@{/factura}">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // --------------------------------------------------------
  // AUTOCOMPLETE tipo navegador para Orden:
  // - mientras escribes -> consulta a /api/factura/ordenes
  // - muestra lista debajo
  // - click o ENTER selecciona
  // - al seleccionar -> carga valorizaciones de esa orden
  // --------------------------------------------------------

  const obraSel = document.getElementById("obraSeleccionada");
  const ordenBusqueda = document.getElementById("ordenBusqueda");
  const ordenId = document.getElementById("ordenId");
  const ordenInfo = document.getElementById("ordenInfo");
  const ordenError = document.getElementById("ordenError");

  const ordenSugerencias = document.getElementById("ordenSugerencias");

  const valSelect = document.getElementById("valorizacionSelect");
  const valInfo = document.getElementById("valInfo");

  // Lista actual de sugerencias y posición seleccionada (para flechas)
  let sugerencias = [];
  let idx = -1;

  // Debounce simple para no spamear el fetch en cada tecla
  let tmr = null;

  function mostrarErrorOrden(msg) {
    ordenError.textContent = msg;
    ordenError.style.display = "block";
  }

  function ocultarErrorOrden() {
    ordenError.style.display = "none";
    ordenError.textContent = "";
  }

  function limpiarValorizaciones() {
    valSelect.innerHTML = '<option value="">-- (sin valorización) --</option>';
    valSelect.value = "";
    valSelect.disabled = true;
    valInfo.textContent = "";
  }

  function limpiarOrden() {
    ordenBusqueda.value = "";
    ordenId.value = "";
    ordenInfo.textContent = "";
    ocultarErrorOrden();
    ocultarSugerencias();
    sugerencias = [];
    idx = -1;
    limpiarValorizaciones();
  }

  function ocultarSugerencias() {
    ordenSugerencias.style.display = "none";
    ordenSugerencias.innerHTML = "";
    idx = -1;
  }

  function pintarSugerencias() {
    ordenSugerencias.innerHTML = "";

    if (sugerencias.length === 0) {
      ocultarSugerencias();
      return;
    }

    sugerencias.forEach((o, i) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "list-group-item list-group-item-action";
      btn.textContent = o.label;

      // marcar seleccionado con flechas
      if (i === idx) {
        btn.classList.add("active");
      }

      // mousedown (no click) para que no se pierda el foco antes de seleccionar
      btn.onmousedown = () => seleccionarOrden(o);

      ordenSugerencias.appendChild(btn);
    });

    ordenSugerencias.style.display = "block";
  }

  async function buscarOrdenes() {
    const idObra = obraSel.value;
    const q = ordenBusqueda.value.trim();

    if (!idObra) return;

    const resp = await fetch(`/api/factura/ordenes?idObra=${idObra}&q=${encodeURIComponent(q)}`);
    sugerencias = await resp.json();
    idx = -1;
    pintarSugerencias();
  }

  async function cargarValorizaciones(idOrden, usaVal) {
    limpiarValorizaciones();

    if (!usaVal) {
      valInfo.textContent = "Esta orden es facturación directa (sin valorización).";
      return;
    }

    const resp = await fetch(`/api/factura/valorizaciones?idOrden=${idOrden}`);
    const data = await resp.json();

    valSelect.disabled = false;
    data.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.idValorizacion;
      opt.textContent = v.label;
      valSelect.appendChild(opt);
    });

    valInfo.textContent = data.length === 0 ? "No hay valorizaciones registradas para esta orden." : "";
  }

  function seleccionarOrden(o) {
    // Guardamos el ID real para el submit
    ordenId.value = o.idOrden;

    // Mostramos el texto “bonito” en el input
    ordenBusqueda.value = o.label;

    ordenInfo.textContent = `Seleccionada: ${o.label}`;
    ocultarErrorOrden();
    ocultarSugerencias();

    // Cargar valorizaciones SOLO de esta orden
    cargarValorizaciones(o.idOrden, o.usaValorizacion);
  }

  // ---------------- eventos ----------------

  obraSel.addEventListener("change", () => {
    limpiarOrden();
    ordenBusqueda.disabled = !obraSel.value;
  });

  ordenBusqueda.addEventListener("input", () => {
    // Si el usuario empieza a escribir, invalida selección anterior
    ordenId.value = "";
    ordenInfo.textContent = "";
    ocultarErrorOrden();

    clearTimeout(tmr);
    tmr = setTimeout(() => {
      buscarOrdenes();
    }, 180);
  });

  // Flechas + enter como navegador
  ordenBusqueda.addEventListener("keydown", (e) => {
    if (ordenSugerencias.style.display !== "block") return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      idx = Math.min(idx + 1, sugerencias.length - 1);
      pintarSugerencias();
    }

    if (e.key === "ArrowUp") {
      e.preventDefault();
      idx = Math.max(idx - 1, 0);
      pintarSugerencias();
    }

    if (e.key === "Enter") {
      // Si hay selección con flechas, la tomamos.
      // Si no, y hay 1 sola sugerencia, tomamos la primera.
      if (idx >= 0 && sugerencias[idx]) {
        e.preventDefault();
        seleccionarOrden(sugerencias[idx]);
      } else if (sugerencias.length === 1) {
        e.preventDefault();
        seleccionarOrden(sugerencias[0]);
      } else {
        // Si hay varias, no “bloqueamos”: solo dejamos que siga escribiendo.
        // (Opcional) podrías mostrar mensaje
      }
    }

    if (e.key === "Escape") {
      ocultarSugerencias();
    }
  });

  // Si se va el foco, ocultamos sugerencias (con delay para permitir click)
  ordenBusqueda.addEventListener("blur", () => {
    setTimeout(() => ocultarSugerencias(), 150);
  });

  ordenBusqueda.addEventListener("focus", () => {
    if (sugerencias.length > 0) pintarSugerencias();
  });

</script>

</body>
</html>